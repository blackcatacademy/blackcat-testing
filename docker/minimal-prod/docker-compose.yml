services:
  db:
    image: mariadb:11
    environment:
      MARIADB_DATABASE: blackcat_test
      MARIADB_USER: blackcat
      MARIADB_PASSWORD: blackcat
      MARIADB_ROOT_PASSWORD: root
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "127.0.0.1", "-uroot", "-proot"]
      interval: 2s
      timeout: 2s
      retries: 30

  app:
    build:
      context: ../../..
      dockerfile: blackcat-testing/docker/minimal-prod/app/Dockerfile
    environment:
      BLACKCAT_TRUST_CHAIN_ID: "${BLACKCAT_TRUST_CHAIN_ID:-4207}"
      BLACKCAT_TRUST_RPC_ENDPOINTS: "${BLACKCAT_TRUST_RPC_ENDPOINTS:-https://rpc.layeredge.io,https://edgenscan.io/api/eth-rpc}"
      BLACKCAT_TRUST_RPC_QUORUM: "${BLACKCAT_TRUST_RPC_QUORUM:-2}"
      BLACKCAT_TRUST_MODE: "${BLACKCAT_TRUST_MODE:-full}"
      BLACKCAT_TRUST_MAX_STALE_SEC: "${BLACKCAT_TRUST_MAX_STALE_SEC:-180}"
      BLACKCAT_TRUST_TIMEOUT_SEC: "${BLACKCAT_TRUST_TIMEOUT_SEC:-5}"
      BLACKCAT_INSTANCE_CONTROLLER: "${BLACKCAT_INSTANCE_CONTROLLER:-0x0000000000000000000000000000000000000001}"
      BLACKCAT_DB_DSN: "${BLACKCAT_DB_DSN:-mysql:host=db;dbname=blackcat_test;charset=utf8mb4}"
      BLACKCAT_DB_USER: "${BLACKCAT_DB_USER:-blackcat}"
      BLACKCAT_DB_PASS: "${BLACKCAT_DB_PASS:-blackcat}"
      BLACKCAT_TESTING_BOOT_MODE: "${BLACKCAT_TESTING_BOOT_MODE:-run}"
      BLACKCAT_TESTING_FORCE_PROVISION: "${BLACKCAT_TESTING_FORCE_PROVISION:-1}"
      BLACKCAT_TESTING_EXIT_AFTER_TAMPER: "${BLACKCAT_TESTING_EXIT_AFTER_TAMPER:-0}"
      BLACKCAT_TESTING_TAMPER_AFTER_SEC: "${BLACKCAT_TESTING_TAMPER_AFTER_SEC:-40}"
      BLACKCAT_TESTING_TAMPER_KIND: "${BLACKCAT_TESTING_TAMPER_KIND:-unexpected_file}"
      BLACKCAT_TESTING_RPC_SABOTAGE_AFTER_SEC: "${BLACKCAT_TESTING_RPC_SABOTAGE_AFTER_SEC:-0}"
      BLACKCAT_TESTING_LOCAL_RPC_PROXY: "${BLACKCAT_TESTING_LOCAL_RPC_PROXY:-0}"
      BLACKCAT_TESTING_RPC_PROXY_PORT: "${BLACKCAT_TESTING_RPC_PROXY_PORT:-8545}"
      BLACKCAT_TESTING_RPC_PROXY_UPSTREAM: "${BLACKCAT_TESTING_RPC_PROXY_UPSTREAM:-https://rpc.layeredge.io}"
      BLACKCAT_TESTING_RPC_PROXY_SABOTAGE_AFTER_SEC: "${BLACKCAT_TESTING_RPC_PROXY_SABOTAGE_AFTER_SEC:-0}"
    ports:
      - "127.0.0.1:8088:8080"
    volumes:
      - blackcat_etc:/etc/blackcat
    depends_on:
      db:
        condition: service_healthy

  runner:
    image: minimal-prod-app
    entrypoint: ["php", "/srv/blackcat/site/bin/trust-runner.php"]
    environment:
      BLACKCAT_TRUST_RUNNER_INTERVAL_SEC: "${BLACKCAT_TRUST_RUNNER_INTERVAL_SEC:-5}"
      BLACKCAT_TRUST_RUNNER_LOG_EVERY_SEC: "${BLACKCAT_TRUST_RUNNER_LOG_EVERY_SEC:-30}"
      BLACKCAT_TESTING_RPC_SABOTAGE_AFTER_SEC: "${BLACKCAT_TESTING_RPC_SABOTAGE_AFTER_SEC:-0}"
    volumes:
      - blackcat_etc:/etc/blackcat
    depends_on:
      app:
        condition: service_started

  attacker:
    build:
      context: ../../..
      dockerfile: blackcat-testing/docker/minimal-prod/attacker/Dockerfile
    environment:
      TARGET_BASE_URL: "${TARGET_BASE_URL:-http://app:8080}"
      ATTACK_DURATION_SEC: "${ATTACK_DURATION_SEC:-120}"
      ATTACK_RPS: "${ATTACK_RPS:-5}"
      TAMPER_AFTER_SEC: "${BLACKCAT_TESTING_TAMPER_AFTER_SEC:-40}"
      ATTACK_LOG_DIR: "${ATTACK_LOG_DIR:-/var/log/blackcat-testing}"
      ATTACK_LOG_EVERY_SEC: "${ATTACK_LOG_EVERY_SEC:-1}"
      ATTACK_READY_TIMEOUT_SEC: "${ATTACK_READY_TIMEOUT_SEC:-60}"
      ATTACK_MAX_CONSECUTIVE_HEALTH_FAILS: "${ATTACK_MAX_CONSECUTIVE_HEALTH_FAILS:-30}"
      EXPECT_TRUST_OK_AT_START: "${EXPECT_TRUST_OK_AT_START:-0}"
      EXPECT_TRUST_FAIL_AFTER_TAMPER: "${EXPECT_TRUST_FAIL_AFTER_TAMPER:-1}"
      EXPECT_STALE_READS_ON_RPC_OUTAGE: "${EXPECT_STALE_READS_ON_RPC_OUTAGE:-0}"
      EXPECT_HEALTH_DOWN_AFTER_TAMPER: "${EXPECT_HEALTH_DOWN_AFTER_TAMPER:-0}"
    volumes:
      - ../../var/harness/minimal-prod/logs:/var/log/blackcat-testing
    depends_on:
      db:
        condition: service_healthy
      app:
        condition: service_started

volumes:
  blackcat_etc: {}
